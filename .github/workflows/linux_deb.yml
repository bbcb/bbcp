name: Build and Package .deb

on:
  workflow_dispatch:

jobs:
  build-deb:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up build environment
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update -y
          sudo apt-get install -y libgtk2.0-0:i386 gtk2-engines:i386 gtk2-engines-murrine:i386 libcanberra-gtk-module:i386
          sudo apt-get install -y pax
          sudo apt-get install -y md5deep lintian

      - name: Build the application
        run: ./build-linux

      - name: Build append
        run: |
          ln -s packaging/Deb
          ./run-dev0 <<DATA
          DevCompiler.CompileSubs Deb
          DATA
          ./run-dev0 <<DATA
          DevLinker1.LinkElf `uname -s` append := Kernel$+ Utf LinKernel Files LinEnv LinFiles Math Strings Meta Log Services Fonts Dialog Ports Stores Sequencers Converters Models Views StdInterpreter Console LinConsole ConsFonts Controllers Properties Mechanisms Containers Dates Printers Printing Documents Windows ConsWindows LinDates LinIntDialog StdRegistry StdDialog  TextModels TextMappers TextRulers TextSetters TextViews TextControllers ConsLog StdApi StdCmds StdCoder DebAppend
          DATA
          mv append packaging/Deb/

      - name: Build the .deb package
        run: ./makePackage
        working-directory: packaging/Deb

      - name: Upload .deb package
        uses: actions/upload-artifact@v4
        with:
          name: bbcb-deb
          path: packaging/Deb/*.deb
